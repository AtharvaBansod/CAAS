{
  "task_group": "auth-pages",
  "description": "Authentication pages and backend gaps — tenant login, registration, password reset, auth middleware",
  "priority": "critical",
  "estimated_hours": 32,
  "phase": "6.1",
  "feature_area": "admin-portal",
  "tasks": [
    {
      "id": "PORTAL-105",
      "task_name": "Backend: Tenant Admin Login Endpoint",
      "feature_details": "Add a new endpoint to the Auth Service for tenant admin login. POST /api/v1/auth/client/login — accepts { email, password }, validates against saas_clients collection, returns { access_token, refresh_token, tenant_id, client_id }. The access_token JWT should include claims: { sub: client_id, email, role: 'tenant_admin', tenantId, iat, exp }. Token expiry: 1 hour for access, 7 days for refresh. Store refresh token in Redis with TTL. This is DIFFERENT from SDK session — it authenticates the tenant administrator, not an end-user.",
      "feature_dependency": [],
      "backend_apis_used": [],
      "backend_status": "TO BE BUILT — Auth Service currently only has client/register, no login",
      "gap_id": "G1",
      "testing_instructions": {
        "unit_tests": [
          "Login with valid credentials returns tokens",
          "Login with invalid email returns 401",
          "Login with wrong password returns 401",
          "JWT contains correct claims (sub, tenantId, role)",
          "Refresh token is stored in Redis"
        ],
        "integration_tests": [
          "Login → validate token → access protected routes",
          "Login with rate limiting (5 attempts per 15 min)"
        ],
        "e2e_tests": [
          "Add to e2e-full-system.js Phase 2: tenant login after registration"
        ]
      },
      "acceptance_criteria": [
        "POST /api/v1/auth/client/login returns access + refresh tokens",
        "JWT contains sub, tenantId, role: tenant_admin",
        "Invalid credentials return 401",
        "Rate limiting prevents brute force",
        "Refresh token stored in Redis with 7-day TTL"
      ],
      "files_to_create": [
        "services/auth-service/src/controllers/admin-auth.controller.ts",
        "services/auth-service/src/services/admin-auth.service.ts"
      ],
      "files_to_modify": [
        "services/auth-service/src/routes/auth.routes.ts"
      ],
      "docker_requirements": {
        "services": [
          "auth-service"
        ],
        "environment_variables": [
          "ADMIN_JWT_SECRET",
          "ADMIN_TOKEN_EXPIRY",
          "ADMIN_REFRESH_TOKEN_EXPIRY"
        ],
        "volumes": [],
        "networks": [
          "caas-network"
        ]
      },
      "api_endpoints": [
        {
          "method": "POST",
          "path": "/api/v1/auth/client/login",
          "request_body": {
            "email": "string",
            "password": "string"
          },
          "response_body": {
            "access_token": "string",
            "refresh_token": "string",
            "tenant_id": "string",
            "client_id": "string",
            "expires_in": "number"
          },
          "auth": "none (public)"
        }
      ],
      "database_changes": {
        "collections": [
          "saas_clients (existing)"
        ],
        "indexes": [
          "{ email: 1 } unique (should already exist)"
        ],
        "migrations": []
      },
      "status": "not_started",
      "estimated_hours": 8,
      "tags": [
        "backend",
        "auth",
        "login",
        "critical-gap"
      ]
    },
    {
      "id": "PORTAL-106",
      "task_name": "Backend: Tenant Admin Refresh Token Endpoint",
      "feature_details": "Add a refresh endpoint for tenant admin tokens. POST /api/v1/auth/client/refresh — accepts { refresh_token }, validates against Redis, issues new access_token and optionally rotates refresh_token (sliding window). Invalidate old refresh token after use (one-time use pattern for security).",
      "feature_dependency": [
        "PORTAL-105"
      ],
      "backend_apis_used": [],
      "backend_status": "TO BE BUILT — SDK has /sdk/refresh but admin refresh is separate",
      "gap_id": "G2",
      "testing_instructions": {
        "unit_tests": [
          "Valid refresh token returns new access token",
          "Expired refresh token returns 401",
          "Used refresh token cannot be reused",
          "New refresh token is issued (rotation)"
        ],
        "integration_tests": [
          "Login → wait → refresh → access protected route with new token"
        ],
        "e2e_tests": []
      },
      "acceptance_criteria": [
        "POST /api/v1/auth/client/refresh returns new tokens",
        "Old refresh token invalidated after use",
        "Expired refresh token returns 401",
        "New access token inherits same claims"
      ],
      "files_to_create": [],
      "files_to_modify": [
        "services/auth-service/src/controllers/admin-auth.controller.ts",
        "services/auth-service/src/services/admin-auth.service.ts",
        "services/auth-service/src/routes/auth.routes.ts"
      ],
      "docker_requirements": {
        "services": [
          "auth-service"
        ],
        "environment_variables": [],
        "volumes": [],
        "networks": [
          "caas-network"
        ]
      },
      "api_endpoints": [
        {
          "method": "POST",
          "path": "/api/v1/auth/client/refresh",
          "request_body": {
            "refresh_token": "string"
          },
          "response_body": {
            "access_token": "string",
            "refresh_token": "string",
            "expires_in": "number"
          },
          "auth": "none (token in body)"
        }
      ],
      "database_changes": {
        "collections": [],
        "indexes": [],
        "migrations": []
      },
      "status": "not_started",
      "estimated_hours": 4,
      "tags": [
        "backend",
        "auth",
        "refresh",
        "critical-gap"
      ]
    },
    {
      "id": "PORTAL-107",
      "task_name": "Registration Page (Frontend)",
      "feature_details": "Create the tenant registration page at /register. Multi-step form: Step 1: Company Name, Email, Password, Confirm Password. Step 2: Plan selection (Free/Business/Enterprise) with feature comparison cards. Step 3: Terms of Service acceptance. On submit, calls POST /api/v1/auth/client/register (EXISTING ✅). On success: stores returned client_id and api_key, redirects to onboarding wizard. On error: shows validation messages. Includes link to /login. Clean, premium design with gradient background.",
      "feature_dependency": [
        "PORTAL-102"
      ],
      "backend_apis_used": [
        "POST /api/v1/auth/client/register (Auth Service — via gateway proxy or direct)"
      ],
      "backend_status": "WORKING ✅ — E2E tested, returns client_id + api_key",
      "testing_instructions": {
        "unit_tests": [
          "Form validates required fields",
          "Password confirmation matches",
          "Email format validation",
          "Plan selection updates state"
        ],
        "integration_tests": [
          "Successful registration redirects to onboarding",
          "Duplicate email shows error",
          "Server errors display toast notification"
        ],
        "e2e_tests": [
          "Complete registration flow end-to-end"
        ]
      },
      "acceptance_criteria": [
        "Multi-step registration form works",
        "Connects to /api/v1/auth/client/register",
        "Shows API key after successful registration",
        "Validation errors displayed inline",
        "Responsive on mobile"
      ],
      "files_to_create": [
        "apps/admin-portal/src/app/(auth)/register/page.tsx",
        "apps/admin-portal/src/app/(auth)/register/components/StepCompany.tsx",
        "apps/admin-portal/src/app/(auth)/register/components/StepPlan.tsx",
        "apps/admin-portal/src/app/(auth)/register/components/StepTerms.tsx",
        "apps/admin-portal/src/app/(auth)/layout.tsx"
      ],
      "files_to_modify": [],
      "docker_requirements": {
        "services": [],
        "environment_variables": [],
        "volumes": [],
        "networks": []
      },
      "api_endpoints": [],
      "database_changes": {
        "collections": [],
        "indexes": [],
        "migrations": []
      },
      "status": "not_started",
      "estimated_hours": 6,
      "tags": [
        "portal",
        "registration",
        "forms",
        "auth"
      ]
    },
    {
      "id": "PORTAL-108",
      "task_name": "Login Page (Frontend)",
      "feature_details": "Create the tenant admin login page at /login. Fields: Email, Password, Remember Me checkbox. On submit, calls POST /api/v1/auth/client/login (from PORTAL-105). On success: stores tokens (httpOnly cookie via Next.js API route recommended for security), redirects to /dashboard. On error: shows 'Invalid credentials' message. Includes links to /register and /forgot-password. Rate limiting feedback: 'Too many attempts, please try again in X minutes'. Clean, premium design matching registration page.",
      "feature_dependency": [
        "PORTAL-102",
        "PORTAL-105"
      ],
      "backend_apis_used": [
        "POST /api/v1/auth/client/login (Auth Service — PORTAL-105 builds this)"
      ],
      "backend_status": "TO BE BUILT — depends on PORTAL-105",
      "testing_instructions": {
        "unit_tests": [
          "Form validates required fields",
          "Login button disabled during submission",
          "Error message displays on failure"
        ],
        "integration_tests": [
          "Successful login redirects to /dashboard",
          "Invalid credentials show error",
          "Remember Me persists session"
        ],
        "e2e_tests": [
          "Register → Login → Dashboard flow"
        ]
      },
      "acceptance_criteria": [
        "Login page connects to tenant login API",
        "Tokens stored securely (httpOnly cookies)",
        "Auto-redirect authenticated users away from login",
        "Error handling for invalid credentials and rate limits",
        "Responsive on mobile"
      ],
      "files_to_create": [
        "apps/admin-portal/src/app/(auth)/login/page.tsx",
        "apps/admin-portal/src/app/api/auth/login/route.ts",
        "apps/admin-portal/src/app/api/auth/refresh/route.ts",
        "apps/admin-portal/src/app/api/auth/logout/route.ts",
        "apps/admin-portal/src/lib/auth.ts"
      ],
      "files_to_modify": [],
      "docker_requirements": {
        "services": [],
        "environment_variables": [],
        "volumes": [],
        "networks": []
      },
      "api_endpoints": [],
      "database_changes": {
        "collections": [],
        "indexes": [],
        "migrations": []
      },
      "status": "not_started",
      "estimated_hours": 6,
      "tags": [
        "portal",
        "login",
        "auth",
        "cookies"
      ]
    },
    {
      "id": "PORTAL-109",
      "task_name": "Auth Middleware & Route Protection",
      "feature_details": "Create Next.js middleware that protects all /dashboard/* routes. Middleware checks for valid JWT in cookies. If expired, attempts silent refresh via /api/auth/refresh API route. If refresh fails, redirect to /login. Create useAuth() hook that exposes: user (tenant info from JWT), isAuthenticated, isLoading, logout(). Unauthenticated users accessing protected routes get redirected to /login with return URL preserved. Authenticated users accessing /login or /register get redirected to /dashboard.",
      "feature_dependency": [
        "PORTAL-108"
      ],
      "backend_apis_used": [
        "POST /api/v1/auth/client/refresh (PORTAL-106)",
        "POST /api/v1/auth/validate (Auth Service — EXISTING ✅)"
      ],
      "backend_status": "Token validation is WORKING ✅, refresh depends on PORTAL-106",
      "testing_instructions": {
        "unit_tests": [
          "Middleware redirects unauthenticated users",
          "Middleware allows authenticated users",
          "useAuth() returns correct user data",
          "Silent refresh works transparently"
        ],
        "integration_tests": [
          "Protected routes redirect to login",
          "Login redirects back to original page",
          "Token expiry triggers refresh"
        ],
        "e2e_tests": [
          "Complete auth flow: register → login → access protected → logout → redirect to login"
        ]
      },
      "acceptance_criteria": [
        "Next.js middleware protects /dashboard/* routes",
        "Silent token refresh works",
        "useAuth() hook provides user context",
        "Return URL preserved on login redirect",
        "Logout clears all tokens and redirects"
      ],
      "files_to_create": [
        "apps/admin-portal/src/middleware.ts",
        "apps/admin-portal/src/hooks/useAuth.ts",
        "apps/admin-portal/src/components/providers/AuthProvider.tsx"
      ],
      "files_to_modify": [
        "apps/admin-portal/src/app/(dashboard)/layout.tsx"
      ],
      "docker_requirements": {
        "services": [],
        "environment_variables": [],
        "volumes": [],
        "networks": []
      },
      "api_endpoints": [],
      "database_changes": {
        "collections": [],
        "indexes": [],
        "migrations": []
      },
      "status": "not_started",
      "estimated_hours": 8,
      "tags": [
        "portal",
        "auth",
        "middleware",
        "route-protection"
      ]
    }
  ]
}