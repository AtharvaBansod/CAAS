{
  "feature_group": "sdk-core",
  "description": "Core SDK setup and API clients",
  "tasks": [
    {
      "task-name": "SDK Project Setup",
      "feature-details": "Initialize the SDK package with TypeScript configuration, Rollup bundler, and proper module exports. Output formats: ESM, CommonJS, and UMD for browser. Tree-shaking enabled. Dual package exports for Node.js and browser environments. Package name: @caas/sdk. Include source maps and TypeScript declarations.",
      "feature-dependency": [],
      "ai-prompt": "Create a new TypeScript SDK package called @caas/sdk. Set up the project structure with:\n\n1. package.json with:\n   - name: @caas/sdk\n   - main: dist/cjs/index.js\n   - module: dist/esm/index.js\n   - browser: dist/umd/caas-sdk.min.js\n   - types: dist/types/index.d.ts\n   - exports field for Node.js conditional exports\n   - sideEffects: false for tree-shaking\n   - peerDependencies: socket.io-client@^4.0.0\n\n2. tsconfig.json with strict mode, ESNext target, and declaration output\n\n3. rollup.config.js that builds:\n   - ESM bundle (preserves modules for tree-shaking)\n   - CommonJS bundle\n   - UMD bundle (minified, for browsers)\n   - Plugins: @rollup/plugin-typescript, @rollup/plugin-node-resolve, @rollup/plugin-commonjs, @rollup/plugin-terser\n\n4. src/index.ts that exports all public APIs:\n   - CAASClient class\n   - Types and interfaces\n   - Error classes\n   - Constants\n\n5. src/types/index.ts with comprehensive TypeScript types for all entities",
      "testing-instructions": "1. Run 'npm run build' and verify all three output formats are generated\n2. Check that TypeScript declarations are generated in dist/types/\n3. Import the UMD bundle in a browser HTML file and verify it works\n4. Import the ESM bundle in a modern bundler (Vite) and verify tree-shaking works\n5. Import the CommonJS bundle in Node.js and verify it works\n6. Run TypeScript compilation with 'tsc --noEmit' to verify types are correct",
      "acceptance_criteria": [
        "Package builds successfully in all three formats",
        "TypeScript declarations are generated",
        "Source maps are generated for debugging",
        "Tree-shaking works with ESM bundle",
        "UMD bundle is minified and works in browser",
        "Package size is under 50KB gzipped",
        "All exports are properly typed"
      ],
      "files_to_create": [
        "packages/sdk/package.json",
        "packages/sdk/tsconfig.json",
        "packages/sdk/rollup.config.js",
        "packages/sdk/src/index.ts",
        "packages/sdk/src/types/index.ts",
        "packages/sdk/src/types/conversation.ts",
        "packages/sdk/src/types/message.ts",
        "packages/sdk/src/types/user.ts",
        "packages/sdk/src/types/options.ts",
        "packages/sdk/README.md"
      ],
      "docker_requirements": null,
      "task_id": "SDK-001"
    },
    {
      "task-name": "CAAS Client Class",
      "feature-details": "Create the main CAASClient class that serves as the entry point for all SDK functionality. Handles initialization with API key and app ID, manages HTTP client instance, exposes sub-clients (messages, conversations, users, media). Implements connect/disconnect for real-time features. Event emitter pattern for notifications.",
      "feature-dependency": ["SDK-001"],
      "ai-prompt": "Create the main CAASClient class in packages/sdk/src/client.ts:\n\n1. Constructor accepts CAASClientOptions:\n   - apiKey (required): API key for authentication\n   - appId (required): Application ID\n   - baseUrl (optional): API base URL, defaults to production\n   - timeout (optional): Request timeout in ms, defaults to 30000\n   - autoConnect (optional): Auto-connect to real-time, defaults to false\n   - debug (optional): Enable debug logging\n\n2. Properties:\n   - conversations: ConversationsClient\n   - messages: MessagesClient\n   - users: UsersClient\n   - media: MediaClient\n   - connected: boolean (readonly)\n\n3. Methods:\n   - connect(): Promise<void> - Connect to Socket.IO for real-time\n   - disconnect(): void - Disconnect from real-time\n   - on(event, handler): Subscribe to events\n   - off(event, handler): Unsubscribe from events\n   - once(event, handler): One-time event subscription\n\n4. Implement EventEmitter pattern for:\n   - 'message' - New message received\n   - 'message:updated' - Message updated\n   - 'message:deleted' - Message deleted\n   - 'conversation:created' - New conversation\n   - 'conversation:updated' - Conversation updated\n   - 'presence' - User presence changed\n   - 'typing' - Typing indicator\n   - 'connected' - Socket connected\n   - 'disconnected' - Socket disconnected\n   - 'error' - Error occurred\n\n5. Create internal HttpClient class for REST API calls",
      "testing-instructions": "1. Create a test file that instantiates CAASClient with mock options\n2. Verify all sub-clients are accessible (conversations, messages, users, media)\n3. Test event emitter: subscribe, emit, unsubscribe\n4. Test that connect() throws if apiKey or appId is missing\n5. Verify debug mode logs to console\n6. Test TypeScript autocompletion for all methods",
      "acceptance_criteria": [
        "CAASClient can be instantiated with required options",
        "All sub-clients are properly initialized",
        "Event emitter pattern works correctly",
        "TypeScript types are correct for all methods",
        "Debug mode provides useful logging",
        "Errors are properly typed",
        "Client is tree-shakeable"
      ],
      "files_to_create": [
        "packages/sdk/src/client.ts",
        "packages/sdk/src/http-client.ts",
        "packages/sdk/src/event-emitter.ts",
        "packages/sdk/src/utils/errors.ts",
        "packages/sdk/src/constants.ts"
      ],
      "docker_requirements": null,
      "task_id": "SDK-002"
    },
    {
      "task-name": "Conversations API Client",
      "feature-details": "Implement the ConversationsClient for CRUD operations on conversations. Support direct messages (1:1), group chats, and channels. Pagination with cursor-based navigation. Rich filtering options. Participant management (add/remove users).",
      "feature-dependency": ["SDK-002"],
      "ai-prompt": "Create ConversationsClient in packages/sdk/src/api/conversations.ts:\n\n1. list(options?: ListConversationsOptions): Promise<PaginatedResult<Conversation>>\n   Options:\n   - type?: 'direct' | 'group' | 'channel'\n   - participantId?: string (filter by participant)\n   - cursor?: string\n   - limit?: number (default 20, max 100)\n   - includeArchived?: boolean\n\n2. get(conversationId: string): Promise<Conversation>\n   Returns full conversation with participants\n\n3. create(options: CreateConversationOptions): Promise<Conversation>\n   Options:\n   - type: 'direct' | 'group' | 'channel'\n   - participantIds: string[] (for direct, exactly 1 other user)\n   - name?: string (required for group/channel)\n   - metadata?: Record<string, any>\n   - isPrivate?: boolean (for channels)\n\n4. update(conversationId: string, options: UpdateConversationOptions): Promise<Conversation>\n   Options:\n   - name?: string\n   - metadata?: Record<string, any>\n   - avatar?: string\n\n5. delete(conversationId: string): Promise<void>\n   Soft delete the conversation\n\n6. addParticipants(conversationId: string, userIds: string[]): Promise<Conversation>\n\n7. removeParticipants(conversationId: string, userIds: string[]): Promise<Conversation>\n\n8. archive(conversationId: string): Promise<Conversation>\n\n9. unarchive(conversationId: string): Promise<Conversation>\n\n10. getParticipants(conversationId: string): Promise<Participant[]>\n\nUse the HttpClient for all requests. Handle errors with typed CAASError.",
      "testing-instructions": "1. Mock the HttpClient and test each method\n2. Test list() with various filter combinations\n3. Test create() validates required fields based on type\n4. Test that delete() calls the correct endpoint with DELETE method\n5. Test pagination cursor handling\n6. Test error handling for 404, 403, 400 responses\n7. Verify TypeScript types for all inputs and outputs",
      "acceptance_criteria": [
        "All CRUD operations work correctly",
        "Pagination returns cursor for next page",
        "Filters are correctly applied to list requests",
        "Error responses are properly typed",
        "Direct message creation validates exactly 2 participants",
        "Group/channel creation validates name is provided",
        "TypeScript autocompletion works for all options"
      ],
      "files_to_create": [
        "packages/sdk/src/api/conversations.ts",
        "packages/sdk/src/types/pagination.ts"
      ],
      "docker_requirements": null,
      "task_id": "SDK-003"
    },
    {
      "task-name": "Messages API Client",
      "feature-details": "Implement the MessagesClient for sending, retrieving, and managing messages. Support text, media, and rich content messages. Reactions and threading. Read receipts. Message editing and deletion. Optimistic updates support.",
      "feature-dependency": ["SDK-002"],
      "ai-prompt": "Create MessagesClient in packages/sdk/src/api/messages.ts:\n\n1. list(conversationId: string, options?: ListMessagesOptions): Promise<PaginatedResult<Message>>\n   Options:\n   - before?: string (message ID for older messages)\n   - after?: string (message ID for newer messages)\n   - limit?: number (default 50, max 100)\n   - includeDeleted?: boolean\n\n2. get(messageId: string): Promise<Message>\n\n3. send(options: SendMessageOptions): Promise<Message>\n   Options:\n   - conversationId: string\n   - content?: string (text content)\n   - type?: 'text' | 'media' | 'system' | 'card'\n   - attachments?: Attachment[]\n   - replyTo?: string (parent message ID for threading)\n   - metadata?: Record<string, any>\n   - clientId?: string (for optimistic updates)\n\n4. update(messageId: string, options: UpdateMessageOptions): Promise<Message>\n   Options:\n   - content?: string\n   - metadata?: Record<string, any>\n\n5. delete(messageId: string): Promise<void>\n   Soft delete with tombstone\n\n6. addReaction(messageId: string, reaction: string): Promise<Message>\n   Reaction is emoji string\n\n7. removeReaction(messageId: string, reaction: string): Promise<Message>\n\n8. markAsRead(conversationId: string, messageId: string): Promise<void>\n   Mark all messages up to messageId as read\n\n9. getThread(parentMessageId: string, options?: ListMessagesOptions): Promise<PaginatedResult<Message>>\n\n10. search(conversationId: string, query: string, options?: SearchOptions): Promise<SearchResult<Message>>\n\nHandle clientId for optimistic updates - return immediately with pending state.",
      "testing-instructions": "1. Test send() with different content types\n2. Test list() with before/after cursor pagination\n3. Test thread retrieval\n4. Test reaction add/remove\n5. Test markAsRead sends correct message ID\n6. Test search with query string\n7. Test optimistic update with clientId\n8. Test error handling for deleted conversations",
      "acceptance_criteria": [
        "Messages can be sent with text and attachments",
        "Cursor-based pagination works in both directions",
        "Threading retrieves only reply messages",
        "Reactions are properly added and removed",
        "Read receipts are sent correctly",
        "Search returns highlighted results",
        "Optimistic updates work with clientId",
        "Deleted messages return proper tombstone"
      ],
      "files_to_create": [
        "packages/sdk/src/api/messages.ts"
      ],
      "docker_requirements": null,
      "task_id": "SDK-004"
    },
    {
      "task-name": "Users and Media API Clients",
      "feature-details": "Implement UsersClient for user profile management and MediaClient for file uploads/downloads. Support avatar uploads, file attachments, and media URL signing.",
      "feature-dependency": ["SDK-002"],
      "ai-prompt": "Create UsersClient in packages/sdk/src/api/users.ts:\n\n1. getMe(): Promise<User>\n   Get current authenticated user\n\n2. get(userId: string): Promise<User>\n\n3. updateMe(options: UpdateUserOptions): Promise<User>\n   Options:\n   - displayName?: string\n   - avatar?: string (URL or upload)\n   - metadata?: Record<string, any>\n   - status?: string\n\n4. list(options?: ListUsersOptions): Promise<PaginatedResult<User>>\n   Options:\n   - search?: string\n   - cursor?: string\n   - limit?: number\n\n5. getPresence(userIds: string[]): Promise<Record<string, PresenceStatus>>\n   Batch get presence for multiple users\n\n6. setPresence(status: 'online' | 'away' | 'busy' | 'offline'): Promise<void>\n\nCreate MediaClient in packages/sdk/src/api/media.ts:\n\n1. upload(file: File | Blob, options?: UploadOptions): Promise<MediaUploadResult>\n   Options:\n   - filename?: string\n   - mimeType?: string\n   - onProgress?: (progress: number) => void\n   Returns:\n   - id: string\n   - url: string (CDN URL)\n   - thumbnailUrl?: string\n   - size: number\n   - mimeType: string\n\n2. getUploadUrl(options: GetUploadUrlOptions): Promise<PresignedUrl>\n   Get presigned URL for direct upload\n   Options:\n   - filename: string\n   - mimeType: string\n   - size: number\n\n3. get(mediaId: string): Promise<Media>\n\n4. delete(mediaId: string): Promise<void>\n\n5. getSignedUrl(mediaId: string, expiresIn?: number): Promise<string>\n   Get signed URL for private media\n\nImplement progress tracking for uploads using XMLHttpRequest or fetch with ReadableStream.",
      "testing-instructions": "1. Test getMe() returns current user\n2. Test updateMe() with avatar URL\n3. Test batch presence retrieval\n4. Test file upload with progress callback\n5. Test presigned URL generation\n6. Test signed URL for private media\n7. Mock File/Blob for upload tests\n8. Test error handling for oversized files",
      "acceptance_criteria": [
        "User profile CRUD works correctly",
        "Batch presence retrieval returns map of user IDs to status",
        "File upload tracks progress percentage",
        "Presigned URLs are generated correctly",
        "Media metadata is returned after upload",
        "Private media requires signed URLs",
        "Large file uploads are chunked appropriately"
      ],
      "files_to_create": [
        "packages/sdk/src/api/users.ts",
        "packages/sdk/src/api/media.ts",
        "packages/sdk/src/types/presence.ts",
        "packages/sdk/src/types/media.ts"
      ],
      "docker_requirements": null,
      "task_id": "SDK-005"
    },
    {
      "task-name": "HTTP Client with Retry Logic",
      "feature-details": "Implement robust HTTP client with automatic retry, exponential backoff, request/response interceptors, and proper error handling. Support for both browser fetch and Node.js environments.",
      "feature-dependency": ["SDK-001"],
      "ai-prompt": "Create HttpClient in packages/sdk/src/http-client.ts:\n\n1. Constructor accepts HttpClientOptions:\n   - baseUrl: string\n   - apiKey: string\n   - appId: string\n   - timeout?: number (default 30000)\n   - retries?: number (default 3)\n   - retryDelay?: number (default 1000)\n   - debug?: boolean\n\n2. Methods:\n   - get<T>(path: string, options?: RequestOptions): Promise<T>\n   - post<T>(path: string, body: any, options?: RequestOptions): Promise<T>\n   - put<T>(path: string, body: any, options?: RequestOptions): Promise<T>\n   - patch<T>(path: string, body: any, options?: RequestOptions): Promise<T>\n   - delete<T>(path: string, options?: RequestOptions): Promise<T>\n   - request<T>(method: string, path: string, options?: FullRequestOptions): Promise<T>\n\n3. RequestOptions:\n   - headers?: Record<string, string>\n   - query?: Record<string, string | number | boolean>\n   - timeout?: number\n   - signal?: AbortSignal\n   - skipRetry?: boolean\n\n4. Interceptors:\n   - addRequestInterceptor(fn: RequestInterceptor): void\n   - addResponseInterceptor(fn: ResponseInterceptor): void\n\n5. Retry Logic:\n   - Retry on 5xx errors and network failures\n   - Exponential backoff: delay * 2^attempt\n   - Jitter: add random 0-100ms to prevent thundering herd\n   - Skip retry on 4xx errors (client errors)\n   - Respect Retry-After header if present\n\n6. Error Handling:\n   - Parse error response body\n   - Create typed CAASError with code, message, details\n   - Handle timeout with AbortController\n   - Handle network errors\n\n7. Headers:\n   - X-API-Key: apiKey\n   - X-App-ID: appId\n   - Content-Type: application/json\n   - Accept: application/json\n\nUse native fetch API with polyfill detection for Node.js < 18.",
      "testing-instructions": "1. Test successful GET/POST/PUT/PATCH/DELETE requests\n2. Test retry logic with mock 503 responses\n3. Test exponential backoff timing\n4. Test that 4xx errors are not retried\n5. Test timeout with AbortController\n6. Test request interceptor modifies request\n7. Test response interceptor modifies response\n8. Test Retry-After header is respected\n9. Test query parameters are correctly encoded",
      "acceptance_criteria": [
        "All HTTP methods work correctly",
        "Retry logic retries on 5xx and network errors",
        "Exponential backoff is applied correctly",
        "4xx errors are not retried",
        "Timeout cancels request properly",
        "Interceptors can modify requests and responses",
        "Error responses are parsed and typed",
        "Works in both browser and Node.js"
      ],
      "files_to_create": [
        "packages/sdk/src/http-client.ts",
        "packages/sdk/src/utils/retry.ts",
        "packages/sdk/src/utils/query-string.ts"
      ],
      "docker_requirements": null,
      "task_id": "SDK-006"
    }
  ]
}
