{
  "feature_group": "widget-core",
  "description": "Embeddable chat widget core functionality",
  "tasks": [
    {
      "task-name": "Widget Bundle Setup",
      "feature-details": "Set up the widget package with Webpack bundling for CDN distribution. Create a single JavaScript file that includes React and the SDK, optimized for size. Support for modern and legacy browsers.",
      "feature-dependency": ["SDK-001", "SDK-002", "UI-001"],
      "ai-prompt": "Create the @caas/widget package:\n\n1. packages/widget/package.json:\n   - name: @caas/widget\n   - main: dist/widget.min.js\n   - No peerDependencies (all bundled)\n   - Scripts: build, build:dev, analyze\n\n2. packages/widget/webpack.config.js:\n   - Entry: src/index.ts\n   - Output: dist/widget.min.js (UMD, global CAASWidget)\n   - Target: ['web', 'es5'] for legacy support\n   - Optimization:\n     - Minimize with terser\n     - Tree shaking\n     - Code splitting disabled (single file)\n   - Plugins:\n     - DefinePlugin for environment\n     - BundleAnalyzerPlugin (optional)\n   - Externals: none (bundle everything)\n   - DevServer for testing\n\n3. packages/widget/tsconfig.json:\n   - Target ES6, downleveled by Babel\n   - JSX React-JSX\n   - Strict mode\n\n4. packages/widget/babel.config.js:\n   - Presets: @babel/preset-env, @babel/preset-react, @babel/preset-typescript\n   - Targets: '> 0.5%, last 2 versions, not dead'\n\n5. packages/widget/src/index.ts:\n   - Create CAASWidget namespace on window\n   - Export init(), open(), close(), destroy() methods\n   - Export isReady, isOpen properties\n   - Auto-init if data-caas-widget attribute found\n\n6. packages/widget/embed/demo.html:\n   - Demo page with widget embedded\n   - Configuration examples\n   - Event logging\n\n7. Size targets:\n   - < 150KB gzipped including React and SDK\n   - Use preact if React too large\n\n8. Create build script that outputs to dist/",
      "testing-instructions": "1. Run 'npm run build' and verify widget.min.js is generated\n2. Check bundle size is under 150KB gzipped\n3. Open demo.html and verify widget loads\n4. Test CAASWidget.init() creates widget\n5. Test CAASWidget.open() opens chat\n6. Test CAASWidget.close() closes chat\n7. Test CAASWidget.destroy() removes widget\n8. Test in IE11 or legacy browser (if supported)\n9. Run bundle analyzer and check for bloat",
      "acceptance_criteria": [
        "Single JS file is generated",
        "Bundle size under 150KB gzipped",
        "CAASWidget global is available",
        "All methods work correctly",
        "Demo page shows working widget",
        "No console errors",
        "Works in modern browsers",
        "Legacy browser support (optional)"
      ],
      "files_to_create": [
        "packages/widget/package.json",
        "packages/widget/webpack.config.js",
        "packages/widget/tsconfig.json",
        "packages/widget/babel.config.js",
        "packages/widget/src/index.ts",
        "packages/widget/embed/demo.html",
        "packages/widget/README.md"
      ],
      "docker_requirements": null,
      "task_id": "WIDGET-001"
    },
    {
      "task-name": "Widget Launcher Button",
      "feature-details": "Create the floating launcher button that opens/closes the chat widget. Support custom positioning, animations, unread badge, and customizable appearance.",
      "feature-dependency": ["WIDGET-001"],
      "ai-prompt": "Create the widget launcher in packages/widget/src/components/:\n\n1. WidgetButton.tsx:\n   Props (from config):\n   - position: 'bottom-right' | 'bottom-left'\n   - offset: { x: number, y: number }\n   - size: number (default 60)\n   - icon?: string (URL or inline SVG)\n   - backgroundColor: string\n   - iconColor: string\n   - pulseAnimation: boolean\n   - tooltip?: string\n\n   State:\n   - isOpen: boolean (from context)\n   - unreadCount: number (from context)\n\n   Features:\n   - Fixed position button\n   - Click to toggle chat window\n   - Morph animation (button -> close icon)\n   - Pulse animation to attract attention\n   - Unread badge with count\n   - Tooltip on hover\n   - Keyboard accessible\n   - Mobile: larger touch target\n\n2. UnreadBadge.tsx:\n   - Small red circle with number\n   - '9+' for counts > 9\n   - Animate on count change\n   - Position: top-right of button\n\n3. ButtonIcon.tsx:\n   - Default chat icon\n   - Close (X) icon when open\n   - Smooth rotation/morph animation\n   - Support custom icon URL\n\n4. Animations (CSS or Framer Motion):\n   - Entry: scale up + fade in\n   - Pulse: subtle scale animation\n   - Open: rotate to X icon\n   - Badge: pop animation on new message\n\n5. Scoped styles:\n   - Use CSS modules or styled-components\n   - No conflicts with host page\n   - High z-index (999999)\n\n6. Add Storybook stories (internal testing)",
      "testing-instructions": "1. Test button renders at correct position\n2. Test click toggles isOpen state\n3. Test unread badge shows count\n4. Test badge shows '9+' for > 9\n5. Test pulse animation plays\n6. Test morph to close icon when open\n7. Test keyboard: Enter/Space toggles\n8. Test custom icon loads\n9. Test position offset works\n10. Test tooltip appears on hover",
      "acceptance_criteria": [
        "Button renders in correct position",
        "Click toggles chat window",
        "Unread badge displays correctly",
        "Icon morphs to X when open",
        "Pulse animation works",
        "Keyboard accessible",
        "Custom icon support works",
        "Styles don't leak to host page",
        "Mobile touch target is adequate"
      ],
      "files_to_create": [
        "packages/widget/src/components/WidgetButton.tsx",
        "packages/widget/src/components/UnreadBadge.tsx",
        "packages/widget/src/components/ButtonIcon.tsx",
        "packages/widget/src/styles/button.css"
      ],
      "docker_requirements": null,
      "task_id": "WIDGET-002"
    },
    {
      "task-name": "Widget Window Container",
      "feature-details": "Create the chat window that opens when the launcher is clicked. Contains the chat interface using @caas/ui components. Support for iframe isolation for security.",
      "feature-dependency": ["WIDGET-002", "UI-008"],
      "ai-prompt": "Create the widget window in packages/widget/src/components/:\n\n1. WidgetWindow.tsx:\n   Props (from config):\n   - width: number (default 380)\n   - height: number (default 600)\n   - position: 'bottom-right' | 'bottom-left'\n   - offset: { x: number, y: number }\n   - borderRadius: number\n   - shadow: string (CSS box-shadow)\n   - useIframe: boolean (for isolation)\n\n   Features:\n   - Fixed position container\n   - Positioned above/beside launcher button\n   - Entry/exit animations (slide up + fade)\n   - Responsive: full screen on mobile (<480px)\n   - Drag to resize (optional)\n   - Close button in header\n\n2. WidgetChat.tsx:\n   - Uses ChatContainer from @caas/ui\n   - Passes theme configuration\n   - Handles SDK client initialization\n   - Shows loading state while connecting\n   - Error state if connection fails\n\n3. WidgetHeader.tsx:\n   - Custom header for widget mode\n   - Logo/brand name\n   - Status: 'Connected', 'Connecting...'\n   - Minimize/close buttons\n   - Customizable via config\n\n4. IframeContainer.tsx (optional):\n   - Renders chat in iframe for isolation\n   - postMessage communication with parent\n   - Secure cross-origin handling\n   - Style injection into iframe\n\n5. LoadingState.tsx:\n   - Skeleton UI while loading\n   - Animated dots or spinner\n   - 'Connecting...' message\n\n6. ErrorState.tsx:\n   - Error message display\n   - Retry button\n   - Contact support link\n\n7. Window positioning logic:\n   - Calculate position relative to launcher\n   - Ensure window stays in viewport\n   - Handle window resize\n\n8. Scoped styles:\n   - Shadow DOM or iframe isolation\n   - All styles scoped to widget\n   - High z-index",
      "testing-instructions": "1. Test window opens on launcher click\n2. Test window positions correctly\n3. Test animation plays smoothly\n4. Test chat loads inside window\n5. Test close button closes window\n6. Test mobile: full screen mode\n7. Test iframe mode isolates styles\n8. Test loading state displays\n9. Test error state with retry\n10. Test window stays in viewport",
      "acceptance_criteria": [
        "Window opens with animation",
        "Positioned relative to launcher",
        "Chat interface loads correctly",
        "Close button works",
        "Mobile goes full screen",
        "Iframe isolation works (optional)",
        "Loading state is visible",
        "Error state allows retry",
        "Styles are properly scoped",
        "No z-index conflicts"
      ],
      "files_to_create": [
        "packages/widget/src/components/WidgetWindow.tsx",
        "packages/widget/src/components/WidgetChat.tsx",
        "packages/widget/src/components/WidgetHeader.tsx",
        "packages/widget/src/components/IframeContainer.tsx",
        "packages/widget/src/components/LoadingState.tsx",
        "packages/widget/src/components/ErrorState.tsx",
        "packages/widget/src/styles/window.css"
      ],
      "docker_requirements": null,
      "task_id": "WIDGET-003"
    },
    {
      "task-name": "Widget State Management",
      "feature-details": "Implement state management for the widget including context provider, SDK client lifecycle, unread count tracking, and event handling. Support for widget events that host page can subscribe to.",
      "feature-dependency": ["WIDGET-001", "SDK-001"],
      "ai-prompt": "Create widget state management in packages/widget/src/:\n\n1. WidgetProvider.tsx:\n   - React context for widget state\n   - Props: config (WidgetConfig)\n   - State:\n     - isOpen: boolean\n     - isReady: boolean\n     - isConnecting: boolean\n     - error: Error | null\n     - unreadCount: number\n     - currentConversation: Conversation | null\n   - Actions:\n     - open(): void\n     - close(): void\n     - toggle(): void\n     - setConversation(id: string): void\n\n2. useWidget.ts hook:\n   - Access widget context\n   - Returns state and actions\n   - Throws if used outside provider\n\n3. useWidgetClient.ts:\n   - Initialize CAASClient from SDK\n   - Handle authentication\n   - Manage connection lifecycle\n   - Reconnection logic\n   - Clean up on unmount\n\n4. useUnreadCount.ts:\n   - Track unread messages across all conversations\n   - Listen for new message events\n   - Decrement when messages are read\n   - Persist to localStorage (optional)\n\n5. WidgetEvents.ts:\n   - Event emitter for host page\n   - Events:\n     - 'ready' - Widget initialized\n     - 'open' - Chat opened\n     - 'close' - Chat closed\n     - 'message' - New message received\n     - 'error' - Error occurred\n     - 'conversation:start' - New conversation started\n   - Expose on CAASWidget global:\n     - CAASWidget.on(event, handler)\n     - CAASWidget.off(event, handler)\n\n6. StorageManager.ts:\n   - Persist widget state\n   - Remember open/closed state\n   - Store user preferences\n   - Use localStorage with prefix\n\n7. WidgetConfig.ts:\n   - Type definitions for all config options\n   - Default values\n   - Validation\n\n8. Integration with CAASWidget global:\n   - init(config) - Initialize and render\n   - destroy() - Clean up\n   - open() / close() / toggle()\n   - isReady / isOpen getters\n   - on(event, handler) / off(event, handler)",
      "testing-instructions": "1. Test WidgetProvider initializes correctly\n2. Test open/close actions update state\n3. Test useWidgetClient initializes SDK\n4. Test unread count tracks messages\n5. Test events are emitted to host page\n6. Test CAASWidget.on() receives events\n7. Test state persists to localStorage\n8. Test destroy() cleans up properly\n9. Test error state is captured\n10. Test reconnection works after disconnect",
      "acceptance_criteria": [
        "Context provides widget state",
        "SDK client initializes correctly",
        "Unread count updates in real-time",
        "Events are emitted to host page",
        "CAASWidget global API works",
        "State persists across page loads",
        "Cleanup removes all listeners",
        "Error handling is robust",
        "TypeScript types are correct"
      ],
      "files_to_create": [
        "packages/widget/src/WidgetProvider.tsx",
        "packages/widget/src/hooks/useWidget.ts",
        "packages/widget/src/hooks/useWidgetClient.ts",
        "packages/widget/src/hooks/useUnreadCount.ts",
        "packages/widget/src/WidgetEvents.ts",
        "packages/widget/src/StorageManager.ts",
        "packages/widget/src/WidgetConfig.ts",
        "packages/widget/src/types.ts"
      ],
      "docker_requirements": null,
      "task_id": "WIDGET-004"
    }
  ]
}
