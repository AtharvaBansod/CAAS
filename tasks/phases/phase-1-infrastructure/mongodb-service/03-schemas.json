{
  "task_group": "mongodb-schemas",
  "description": "MongoDB schema definitions and migration system for all platform and tenant collections",
  "priority": "critical",
  "estimated_hours": 20,
  "phase": 1,
  "feature_area": "mongodb-service",
  "tasks": [
    {
      "id": "MONGO-009",
      "task_name": "Platform Schema Definitions",
      "feature_details": "Implement Mongoose schemas for all platform-level collections: saas_clients, applications, api_keys, and platform_admins.",
      "feature_dependency": ["MONGO-002"],
      "ai_prompt": "Create platform schema definitions using Mongoose:\n\n1. Create src/schemas/platform/saas-client.schema.ts:\n   Based on schemas/platform/saas_clients.md, implement:\n   - Full schema with all fields (client_id, company_name, contact, status, etc.)\n   - Mongoose plugins for timestamps, soft delete\n   - Virtual fields for computed properties\n   - Static methods for common queries\n   - Instance methods for status transitions\n   - Pre/post hooks for validation and audit\n\n2. Create src/schemas/platform/application.schema.ts:\n   Based on schemas/platform/applications.md:\n   - Application settings and configuration\n   - Domain and IP whitelist arrays\n   - Feature toggles\n   - Reference to parent SAAS client\n\n3. Create src/schemas/platform/api-key.schema.ts:\n   Based on schemas/platform/api_keys.md:\n   - NEVER store plain text keys\n   - Store hashed keys using bcrypt/argon2\n   - Key metadata (name, permissions, expiry)\n   - Last used tracking\n   - Static method for key verification\n\n4. Create src/schemas/platform/platform-admin.schema.ts:\n   Based on schemas/platform/platform_admins.md:\n   - Admin user profiles\n   - Role-based permissions\n   - MFA configuration\n   - Audit trail\n\n5. Schema validation:\n   - Use Zod for runtime validation\n   - Custom validators for email, URL, IP\n   - Required field validation\n   - Enum validation for status fields\n\nFollow MongoDB best practices for schema design.",
      "testing_instructions": {
        "unit_tests": [
          "Test schema validation for all fields",
          "Test virtual field calculations",
          "Test static methods",
          "Test instance methods"
        ],
        "integration_tests": [
          "Test document creation with all fields",
          "Test document updates",
          "Test reference population",
          "Test hook execution"
        ],
        "e2e_tests": []
      },
      "acceptance_criteria": [
        "All platform schemas implemented per documentation",
        "Schema validation catches invalid data",
        "API keys are properly hashed",
        "Soft delete works correctly",
        "Timestamps are automatically managed",
        "Hooks execute for audit logging"
      ],
      "files_to_create": [
        "services/mongodb-service/src/schemas/platform/saas-client.schema.ts",
        "services/mongodb-service/src/schemas/platform/application.schema.ts",
        "services/mongodb-service/src/schemas/platform/api-key.schema.ts",
        "services/mongodb-service/src/schemas/platform/platform-admin.schema.ts",
        "services/mongodb-service/src/schemas/platform/index.ts"
      ],
      "files_to_modify": [
        "services/mongodb-service/src/schemas/index.ts"
      ],
      "docker_requirements": {
        "services": [],
        "environment_variables": [],
        "volumes": [],
        "networks": []
      },
      "api_endpoints": [],
      "database_changes": {
        "collections": ["saas_clients", "applications", "api_keys", "platform_admins"],
        "indexes": [],
        "migrations": []
      },
      "status": "completed",
      "estimated_hours": 5,
      "tags": ["mongodb", "schema", "platform", "mongoose"]
    },
    {
      "id": "MONGO-010",
      "task_name": "Tenant User and Relationship Schemas",
      "feature_details": "Implement schemas for tenant-scoped user management: users, user_devices, user_sessions, and user_relationships.",
      "feature_dependency": ["MONGO-009"],
      "ai_prompt": "Create tenant user-related schemas:\n\n1. Create src/schemas/tenant/user.schema.ts:\n   Based on schemas/saas/users/users.md:\n   - Full user profile (display_name, avatar, status, custom_data)\n   - Presence information (online, last_seen)\n   - Notification settings\n   - Privacy settings\n   - E2E encryption public key reference\n   - External user ID mapping for SAAS integration\n   - Always includes tenant_id field\n\n2. Create src/schemas/tenant/user-device.schema.ts:\n   Based on schemas/saas/users/user_devices.md:\n   - Device identification (type, OS, browser)\n   - Push notification tokens\n   - E2E encryption device keys\n   - Last active timestamp\n   - Device-specific settings\n\n3. Create src/schemas/tenant/user-session.schema.ts:\n   Based on schemas/saas/users/user_sessions.md:\n   - Session tokens (hashed)\n   - IP address and geolocation\n   - Device reference\n   - Expiry time\n   - Activity timestamps\n\n4. Create src/schemas/tenant/user-relationship.schema.ts:\n   Based on schemas/saas/users/user_relationships.md:\n   - Relationship types (friend, blocked, muted, following)\n   - Bidirectional relationship support\n   - Relationship metadata (nickname, notes)\n   - Created/updated timestamps\n\n5. Add compound indexes for:\n   - tenant_id + external_user_id (unique)\n   - tenant_id + status + last_seen\n   - tenant_id + user_id + relationship_type\n\nAll schemas must enforce tenant_id requirement.",
      "testing_instructions": {
        "unit_tests": [
          "Test user schema validation",
          "Test device schema validation",
          "Test session expiry logic",
          "Test relationship type validation"
        ],
        "integration_tests": [
          "Test user creation and retrieval",
          "Test multi-device support",
          "Test session management",
          "Test relationship CRUD"
        ],
        "e2e_tests": []
      },
      "acceptance_criteria": [
        "User schema matches documented design",
        "External ID mapping works correctly",
        "Device registration captures all metadata",
        "Session expiry is enforced",
        "Relationships are properly bidirectional",
        "All queries include tenant isolation"
      ],
      "files_to_create": [
        "services/mongodb-service/src/schemas/tenant/user.schema.ts",
        "services/mongodb-service/src/schemas/tenant/user-device.schema.ts",
        "services/mongodb-service/src/schemas/tenant/user-session.schema.ts",
        "services/mongodb-service/src/schemas/tenant/user-relationship.schema.ts"
      ],
      "files_to_modify": [],
      "docker_requirements": {
        "services": [],
        "environment_variables": [],
        "volumes": [],
        "networks": []
      },
      "api_endpoints": [],
      "database_changes": {
        "collections": ["users", "user_devices", "user_sessions", "user_relationships"],
        "indexes": [
          "tenant_id_external_user_id_unique",
          "tenant_id_status_last_seen",
          "tenant_id_user_id_relationship_type"
        ],
        "migrations": []
      },
      "status": "completed",
      "estimated_hours": 4,
      "tags": ["mongodb", "schema", "users", "tenant"]
    },
    {
      "id": "MONGO-011",
      "task_name": "Messaging Schemas Implementation",
      "feature_details": "Implement schemas for the messaging domain: conversations, messages, reactions, and read_receipts.",
      "feature_dependency": ["MONGO-010"],
      "ai_prompt": "Create messaging domain schemas:\n\n1. Create src/schemas/tenant/conversation.schema.ts:\n   Based on schemas/saas/messaging/conversations.md:\n   - Conversation types: direct, group, channel\n   - Participants array with roles (owner, admin, member)\n   - Participant settings (muted, pinned, notification_level)\n   - Group metadata (name, avatar, description)\n   - Last message denormalization for list performance\n   - Created/updated timestamps\n   - Soft delete support\n\n2. Create src/schemas/tenant/message.schema.ts:\n   Based on schemas/saas/messaging/messages.md:\n   - Message types: text, image, video, audio, file, voice, location, contact, sticker, system\n   - E2E encrypted content storage\n   - Per-recipient encrypted keys for groups\n   - Media reference with CDN URLs\n   - Reply/thread support (parent_id, reply_count)\n   - Edit history\n   - Soft delete with deleted_at\n   - Delivery status tracking\n\n3. Create src/schemas/tenant/reaction.schema.ts:\n   Based on schemas/saas/messaging/reactions.md:\n   - Emoji reactions per message\n   - User and timestamp\n   - Aggregated counts for performance\n\n4. Create src/schemas/tenant/read-receipt.schema.ts:\n   Based on schemas/saas/messaging/read_receipts.md:\n   - Last read message per user per conversation\n   - Read timestamp\n   - Delivery timestamp\n\n5. Indexes for performance:\n   - messages: tenant_id + conversation_id + created_at (for pagination)\n   - messages: tenant_id + sender_id + created_at\n   - conversations: tenant_id + participants.user_id + updated_at\n\nOptimize for the most common query patterns.",
      "testing_instructions": {
        "unit_tests": [
          "Test message content validation",
          "Test conversation participant validation",
          "Test reaction aggregation",
          "Test read receipt calculations"
        ],
        "integration_tests": [
          "Test conversation creation (direct and group)",
          "Test message sending and retrieval",
          "Test reaction add/remove",
          "Test read receipt updates",
          "Test message pagination performance"
        ],
        "e2e_tests": []
      },
      "acceptance_criteria": [
        "All message types are properly validated",
        "E2E encrypted content is stored correctly",
        "Conversation participants are managed properly",
        "Reactions are aggregated for performance",
        "Read receipts track correctly",
        "Message pagination is efficient (< 50ms for 50 messages)"
      ],
      "files_to_create": [
        "services/mongodb-service/src/schemas/tenant/conversation.schema.ts",
        "services/mongodb-service/src/schemas/tenant/message.schema.ts",
        "services/mongodb-service/src/schemas/tenant/reaction.schema.ts",
        "services/mongodb-service/src/schemas/tenant/read-receipt.schema.ts",
        "services/mongodb-service/src/schemas/tenant/index.ts"
      ],
      "files_to_modify": [],
      "docker_requirements": {
        "services": [],
        "environment_variables": [],
        "volumes": [],
        "networks": []
      },
      "api_endpoints": [],
      "database_changes": {
        "collections": ["conversations", "messages", "reactions", "read_receipts"],
        "indexes": [
          "messages_tenant_conversation_created",
          "messages_tenant_sender_created",
          "conversations_tenant_participants_updated"
        ],
        "migrations": []
      },
      "status": "not_started",
      "estimated_hours": 5,
      "tags": ["mongodb", "schema", "messaging", "tenant"]
    },
    {
      "id": "MONGO-012",
      "task_name": "Media and File Schemas",
      "feature_details": "Implement schemas for file storage metadata, posts/reels, and media processing.",
      "feature_dependency": ["MONGO-011"],
      "ai_prompt": "Create media and file schemas:\n\n1. Create src/schemas/tenant/file.schema.ts:\n   Based on schemas/saas/media/files.md:\n   - Storage metadata (provider, bucket, key, CDN URL)\n   - File metadata (name, mime_type, size, checksum)\n   - Dimensions for images/videos\n   - E2E encryption metadata\n   - Sharing settings (private, chat, public)\n   - Expiry for temporary files\n   - Processing status\n   - Thumbnail references\n\n2. Create src/schemas/tenant/post.schema.ts:\n   Based on schemas/saas/media/posts.md:\n   - Post types: text, image, video, reel, story\n   - Content with media references\n   - Visibility (public, friends, private)\n   - Engagement metrics (likes, comments, shares)\n   - Expiry for stories\n   - Hashtags and mentions\n\n3. Create src/schemas/tenant/media-metadata.schema.ts:\n   Based on schemas/saas/media/media_metadata.md:\n   - Processing job tracking\n   - Transcoding outputs (multiple resolutions)\n   - Content analysis results\n   - Moderation status\n\n4. Create src/schemas/tenant/group.schema.ts:\n   Based on schemas/saas/groups/groups.md:\n   - Group metadata\n   - Group settings\n   - Linked conversation reference\n\n5. Create src/schemas/tenant/group-member.schema.ts:\n   Based on schemas/saas/groups/group_members.md:\n   - Member roles and permissions\n   - Join/leave tracking\n   - Invitation metadata\n\nFile queries must be optimized for listing by conversation and user.",
      "testing_instructions": {
        "unit_tests": [
          "Test file metadata validation",
          "Test post visibility rules",
          "Test media processing status transitions"
        ],
        "integration_tests": [
          "Test file upload metadata storage",
          "Test post creation with media",
          "Test file listing by conversation",
          "Test group member management"
        ],
        "e2e_tests": []
      },
      "acceptance_criteria": [
        "File metadata captures all storage information",
        "Posts support all content types",
        "Media processing status is tracked",
        "Groups and members are properly linked",
        "File queries are performant"
      ],
      "files_to_create": [
        "services/mongodb-service/src/schemas/tenant/file.schema.ts",
        "services/mongodb-service/src/schemas/tenant/post.schema.ts",
        "services/mongodb-service/src/schemas/tenant/media-metadata.schema.ts",
        "services/mongodb-service/src/schemas/tenant/group.schema.ts",
        "services/mongodb-service/src/schemas/tenant/group-member.schema.ts"
      ],
      "files_to_modify": [
        "services/mongodb-service/src/schemas/tenant/index.ts"
      ],
      "docker_requirements": {
        "services": [],
        "environment_variables": [],
        "volumes": [],
        "networks": []
      },
      "api_endpoints": [],
      "database_changes": {
        "collections": ["files", "posts", "media_metadata", "groups", "group_members"],
        "indexes": [
          "files_tenant_uploader_created",
          "files_tenant_conversation_created",
          "posts_tenant_visibility_created"
        ],
        "migrations": []
      },
      "status": "not_started",
      "estimated_hours": 3,
      "tags": ["mongodb", "schema", "files", "media", "groups"]
    },
    {
      "id": "MONGO-013",
      "task_name": "Migration System Implementation",
      "feature_details": "Implement a database migration system for managing schema changes across versions.",
      "feature_dependency": ["MONGO-012"],
      "ai_prompt": "Create a robust database migration system:\n\n1. Create src/migrations/migration-runner.ts:\n   - MigrationRunner class\n   - Methods:\n     * run(): Execute pending migrations\n     * rollback(steps: number): Rollback migrations\n     * status(): Get migration status\n     * create(name: string): Create new migration file\n   - Transaction support for atomic migrations\n   - Locking to prevent concurrent migrations\n\n2. Create src/migrations/migration.interface.ts:\n   - Migration interface:\n     * version: string (semver or timestamp)\n     * name: string\n     * up(): Promise<void>\n     * down(): Promise<void>\n\n3. Create src/migrations/migration-history.ts:\n   - Track applied migrations in _migrations collection\n   - Store execution time, status, error messages\n\n4. Create initial migrations in src/migrations/versions/:\n   - V001_CreatePlatformCollections.ts\n   - V002_CreatePlatformIndexes.ts\n   - V003_CreateBillingCollections.ts\n   - V004_CreateAnalyticsCollections.ts\n   - V005_CreateSecurityCollections.ts\n\n5. CLI commands:\n   - npm run migrate - Run all pending migrations\n   - npm run migrate:rollback - Rollback last migration\n   - npm run migrate:status - Show migration status\n   - npm run migrate:create <name> - Create new migration\n\n6. Features:\n   - Dry run mode\n   - Verbose logging\n   - Retry failed migrations\n   - Backup before migration (optional)\n\nMigrations should be idempotent and safe to run multiple times.",
      "testing_instructions": {
        "unit_tests": [
          "Test migration ordering",
          "Test version comparison",
          "Test dry run mode"
        ],
        "integration_tests": [
          "Test migration execution",
          "Test rollback functionality",
          "Test concurrent migration locking",
          "Test failure recovery"
        ],
        "e2e_tests": []
      },
      "acceptance_criteria": [
        "Migrations run in correct order",
        "Rollback reverses changes correctly",
        "Concurrent migrations are prevented",
        "Failed migrations can be retried",
        "Migration history is accurate",
        "CLI commands work correctly"
      ],
      "files_to_create": [
        "services/mongodb-service/src/migrations/migration-runner.ts",
        "services/mongodb-service/src/migrations/migration.interface.ts",
        "services/mongodb-service/src/migrations/migration-history.ts",
        "services/mongodb-service/src/migrations/migration-lock.ts",
        "services/mongodb-service/src/migrations/index.ts",
        "services/mongodb-service/src/migrations/versions/V001_CreatePlatformCollections.ts",
        "services/mongodb-service/src/migrations/versions/V002_CreatePlatformIndexes.ts",
        "services/mongodb-service/src/migrations/versions/V003_CreateBillingCollections.ts",
        "services/mongodb-service/src/migrations/versions/V004_CreateAnalyticsCollections.ts",
        "services/mongodb-service/src/migrations/versions/V005_CreateSecurityCollections.ts"
      ],
      "files_to_modify": [
        "services/mongodb-service/package.json"
      ],
      "docker_requirements": {
        "services": [],
        "environment_variables": [],
        "volumes": [],
        "networks": []
      },
      "api_endpoints": [],
      "database_changes": {
        "collections": ["_migrations"],
        "indexes": [],
        "migrations": ["All initial migrations"]
      },
      "status": "not_started",
      "estimated_hours": 3,
      "tags": ["mongodb", "migrations", "schema", "cli"]
    }
  ]
}
