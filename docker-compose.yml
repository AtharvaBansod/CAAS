name: caas

# ============================================================
# CAAS Platform - Unified Docker Compose
# Phase 1: Infrastructure Services (MongoDB, Kafka, Gateway)
# ============================================================

networks:
  caas-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  mongodb_primary_data:
  mongodb_secondary1_data:
  mongodb_secondary2_data:
  mongodb_config:
  redis_gateway_data:
  redis_socket_data:
  redis_shared_data:
  redis_compliance_data:
  redis_crypto_data:
  kafka1_data:
  kafka2_data:
  kafka3_data:
  zookeeper_data:
  minio_data:
  elasticsearch_data:

services:
  # ============================================
  # DATABASE SERVICES
  # ============================================
  
  mongodb-primary:
    image: mongo:7.0
    container_name: caas-mongodb-primary
    hostname: mongodb-primary
    entrypoint:
      - bash
      - -c
      - |
        mkdir -p /etc/mongo
        cp /tmp/mongo-keyfile /etc/mongo/mongo-keyfile
        chmod 400 /etc/mongo/mongo-keyfile
        chown 999:999 /etc/mongo/mongo-keyfile
        exec docker-entrypoint.sh mongod --replSet caas-rs --bind_ip_all --keyFile /etc/mongo/mongo-keyfile
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-caas_admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-caas_secret_2026}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_primary_data:/data/db
      - mongodb_config:/data/configdb
      - ./services/mongodb-service/mongo-keyfile:/tmp/mongo-keyfile:ro
    networks:
      caas-network:
        ipv4_address: 172.28.1.1
    healthcheck:
      test: |
        mongosh -u ${MONGO_ROOT_USER:-caas_admin} -p ${MONGO_ROOT_PASSWORD:-caas_secret_2026} --authenticationDatabase admin --eval "
        try {
          db.adminCommand('ping');
          print('MongoDB is healthy');
        } catch(e) {
          print('MongoDB is not ready');
          quit(1);
        }
        " --quiet || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  mongodb-secondary-1:
    image: mongo:7.0
    container_name: caas-mongodb-secondary-1
    hostname: mongodb-secondary-1
    entrypoint:
      - bash
      - -c
      - |
        mkdir -p /etc/mongo
        cp /tmp/mongo-keyfile /etc/mongo/mongo-keyfile
        chmod 400 /etc/mongo/mongo-keyfile
        chown 999:999 /etc/mongo/mongo-keyfile
        exec docker-entrypoint.sh mongod --replSet caas-rs --bind_ip_all --keyFile /etc/mongo/mongo-keyfile
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-caas_admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-caas_secret_2026}
    volumes:
      - mongodb_secondary1_data:/data/db
      - ./services/mongodb-service/mongo-keyfile:/tmp/mongo-keyfile:ro
    networks:
      caas-network:
        ipv4_address: 172.28.1.2
    depends_on:
      mongodb-primary:
        condition: service_healthy
    restart: unless-stopped

  mongodb-secondary-2:
    image: mongo:7.0
    container_name: caas-mongodb-secondary-2
    hostname: mongodb-secondary-2
    entrypoint:
      - bash
      - -c
      - |
        mkdir -p /etc/mongo
        cp /tmp/mongo-keyfile /etc/mongo/mongo-keyfile
        chmod 400 /etc/mongo/mongo-keyfile
        chown 999:999 /etc/mongo/mongo-keyfile
        exec docker-entrypoint.sh mongod --replSet caas-rs --bind_ip_all --keyFile /etc/mongo/mongo-keyfile
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-caas_admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-caas_secret_2026}
    volumes:
      - mongodb_secondary2_data:/data/db
      - ./services/mongodb-service/mongo-keyfile:/tmp/mongo-keyfile:ro
    networks:
      caas-network:
        ipv4_address: 172.28.1.3
    depends_on:
      mongodb-primary:
        condition: service_healthy
    restart: unless-stopped

  # MongoDB Initialization Service
  # Note: Initialization is now handled by start.ps1 script (no init container needed)
  # mongodb-init:
  #   image: mongo:7.0
  #   container_name: caas-mongodb-init
  #   depends_on:
  #     mongodb-primary:
  #       condition: service_healthy
  #   networks:
  #     - caas-network
  #   environment:
  #     - MONGO_ROOT_USER=${MONGO_ROOT_USER:-caas_admin}
  #     - MONGO_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-caas_secret_2026}
  #     - MONGO_APP_PASSWORD=${MONGO_APP_PASSWORD:-caas_app_secret_2026}
  #   volumes:
  #     - ./init/mongodb/init-replica-and-collections.sh:/docker-entrypoint-initdb.d/init.sh:ro
  #   command: bash /docker-entrypoint-initdb.d/init.sh
  #   restart: "no"

  # ============================================
  # REDIS SERVICES (Phase 4.5.z - Multiple Instances)
  # ============================================

  redis-gateway:
    image: redis:7-alpine
    container_name: caas-redis-gateway
    hostname: redis-gateway
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-caas_redis_2026} --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_gateway_data:/data
    networks:
      caas-network:
        ipv4_address: 172.28.2.1
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-caas_redis_2026}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-socket:
    image: redis:7-alpine
    container_name: caas-redis-socket
    hostname: redis-socket
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-caas_redis_2026} --maxmemory 512mb --maxmemory-policy volatile-lru
    ports:
      - "6380:6379"
    volumes:
      - redis_socket_data:/data
    networks:
      caas-network:
        ipv4_address: 172.28.2.2
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-caas_redis_2026}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-shared:
    image: redis:7-alpine
    container_name: caas-redis-shared
    hostname: redis-shared
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-caas_redis_2026} --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6381:6379"
    volumes:
      - redis_shared_data:/data
    networks:
      caas-network:
        ipv4_address: 172.28.2.3
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-caas_redis_2026}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-compliance:
    image: redis:7-alpine
    container_name: caas-redis-compliance
    hostname: redis-compliance
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-caas_redis_2026} --maxmemory 256mb --maxmemory-policy noeviction
    ports:
      - "6382:6379"
    volumes:
      - redis_compliance_data:/data
    networks:
      caas-network:
        ipv4_address: 172.28.2.4
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-caas_redis_2026}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-crypto:
    image: redis:7-alpine
    container_name: caas-redis-crypto
    hostname: redis-crypto
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-caas_redis_2026} --maxmemory 256mb --maxmemory-policy noeviction
    ports:
      - "6383:6379"
    volumes:
      - redis_crypto_data:/data
    networks:
      caas-network:
        ipv4_address: 172.28.2.5
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-caas_redis_2026}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================
  # MESSAGE QUEUE SERVICES
  # ============================================

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: caas-zookeeper
    hostname: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_4LW_COMMANDS_WHITELIST: "srvr,mntr,ruok"
      ZOOKEEPER_HEAP_OPTS: "-Xmx256M -Xms256M"

    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      caas-network:
        ipv4_address: 172.28.3.1
    healthcheck:
      test: ["CMD-SHELL", "echo srvr | nc localhost 2181 | grep Mode"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  kafka-1:
    image: confluentinc/cp-kafka:7.5.0
    container_name: caas-kafka-1
    hostname: kafka-1
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      KAFKA_HEAP_OPTS: "-Xmx256M -Xms256M"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_NUM_PARTITIONS: 3
    volumes:
      - kafka1_data:/var/lib/kafka/data
    networks:
      caas-network:
        ipv4_address: 172.28.3.2
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  kafka-2:
    image: confluentinc/cp-kafka:7.5.0
    container_name: caas-kafka-2
    hostname: kafka-2
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9096:9092"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-2:29092,PLAINTEXT_HOST://localhost:9096
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      KAFKA_HEAP_OPTS: "-Xmx256M -Xms256M"
    volumes:
      - kafka2_data:/var/lib/kafka/data
    networks:
      caas-network:
        ipv4_address: 172.28.3.3
    restart: unless-stopped

  kafka-3:
    image: confluentinc/cp-kafka:7.5.0
    container_name: caas-kafka-3
    hostname: kafka-3
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9094:9092"
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-3:29092,PLAINTEXT_HOST://localhost:9094
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      KAFKA_HEAP_OPTS: "-Xmx256M -Xms256M"
    volumes:
      - kafka3_data:/var/lib/kafka/data
    networks:
      caas-network:
        ipv4_address: 172.28.3.4
    restart: unless-stopped

  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    container_name: caas-schema-registry
    hostname: schema-registry
    depends_on:
      kafka-1:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka-1:29092,kafka-2:29092,kafka-3:29092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
    networks:
      caas-network:
        ipv4_address: 172.28.3.5
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # ============================================
  # AUTH SERVICE (Phase 4.5.0)
  # ============================================

  auth-service:
    build:
      context: .
      dockerfile: ./Dockerfile.common
      target: auth-service
    container_name: caas-auth-service
    hostname: auth-service
    ports:
      - "3007:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - AUTH_PORT=3001
      - AUTH_HOST=0.0.0.0
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017/caas_platform?authSource=admin&replicaSet=caas-rs
      - REDIS_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-gateway:6379/0
      - REDIS_HOST=redis-gateway
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-caas_redis_2026}
      - REDIS_DB=0
      - KAFKA_BROKERS=kafka-1:29092,kafka-2:29092,kafka-3:29092
      # Phase 4.5.z.x: JWT_SECRET replaces RSA key files
      - JWT_SECRET=${JWT_SECRET:-change_this_in_production_please}
      - JWT_ACCESS_TOKEN_EXPIRY=900
      - JWT_REFRESH_TOKEN_EXPIRY=604800
      - JWT_ISSUER=caas-auth-service
      - SERVICE_SECRET=${SERVICE_SECRET:-dev-service-secret}
      - SESSION_TTL_SECONDS=86400
      - MAX_SESSIONS_PER_USER=10
      - COMPLIANCE_SERVICE_URL=http://compliance-service:3008
      - CORS_ORIGINS=http://gateway:3000,http://localhost:3000
      - RATE_LIMIT_MAX=10000
      - RATE_LIMIT_WINDOW_MS=900000
    networks:
      caas-network:
        ipv4_address: 172.28.5.1
    depends_on:
      mongodb-primary:
        condition: service_healthy
      redis-gateway:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://127.0.0.1:3001/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================================
  # COMPLIANCE SERVICE (Phase 4.5.1)
  # ============================================

  compliance-service:
    build:
      context: .
      dockerfile: ./Dockerfile.common
      target: compliance-service
    container_name: caas-compliance-service
    hostname: compliance-service
    ports:
      - "3008:3008"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3008
      - HOST=0.0.0.0
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017/caas_compliance?authSource=admin&replicaSet=caas-rs
      - REDIS_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-compliance:6379/0
      - CORS_ORIGINS=http://gateway:3000,http://localhost:3000
      - RATE_LIMIT_MAX=100
      - RATE_LIMIT_WINDOW=3600000
    networks:
      caas-network:
        ipv4_address: 172.28.5.2
    depends_on:
      mongodb-primary:
        condition: service_healthy
      redis-compliance:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://127.0.0.1:3008/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================================
  # CRYPTO SERVICE (Phase 4.5.2)
  # ============================================

  crypto-service:
    build:
      context: .
      dockerfile: ./Dockerfile.common
      target: crypto-service
    container_name: caas-crypto-service
    hostname: crypto-service
    ports:
      - "3009:3009"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3009
      - HOST=0.0.0.0
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017/caas_crypto?authSource=admin&replicaSet=caas-rs
      - REDIS_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-crypto:6379/0
      - COMPLIANCE_SERVICE_URL=http://compliance-service:3008
      - CORS_ORIGINS=http://gateway:3000,http://localhost:3000
      - RATE_LIMIT_MAX=1000
      - RATE_LIMIT_WINDOW=3600000
    networks:
      caas-network:
        ipv4_address: 172.28.5.3
    depends_on:
      mongodb-primary:
        condition: service_healthy
      redis-crypto:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://127.0.0.1:3009/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================================
  # API GATEWAY SERVICE
  # ============================================

  gateway:
    build:
      context: .
      dockerfile: ./Dockerfile.common
      target: gateway-service
    container_name: caas-gateway
    hostname: gateway
    ports:
      - "3000:3000"
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=3000
      - METRICS_PORT=3001
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017/caas_platform?authSource=admin&replicaSet=caas-rs
      - REDIS_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-gateway:6379/0
      - REDIS_SHARED_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-shared:6379/0
      - REDIS_HOST=redis-gateway
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-caas_redis_2026}
      - REDIS_DB=0
      - KAFKA_BROKERS=kafka-1:29092,kafka-2:29092,kafka-3:29092
      - JWT_SECRET=${JWT_SECRET:-change_this_in_production_please}
      # Phase 4.5.z.x: Service secret for inter-service communication
      - SERVICE_SECRET=${SERVICE_SECRET:-dev-service-secret}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD:-changeme}
      - MEDIA_SERVICE_URL=http://media-service:3005
      - SEARCH_SERVICE_URL=http://search-service:3006
      - AUTH_SERVICE_URL=http://auth-service:3001
      - COMPLIANCE_SERVICE_URL=http://compliance-service:3008
      - SOCKET_SERVICE_1_URL=ws://socket-service-1:3001
      - SOCKET_SERVICE_2_URL=ws://socket-service-2:3001
      - SEARCH_CACHE_TTL_SECONDS=60
    networks:
      caas-network:
        ipv4_address: 172.28.6.1
    depends_on:
      mongodb-primary:
        condition: service_healthy
      redis-gateway:
        condition: service_healthy
      redis-shared:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      media-service:
        condition: service_healthy
      search-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://127.0.0.1:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    command: node dist/src/main.js

  # ============================================
  # ADMIN PORTAL (CLIENT UI)
  # ============================================

  admin-portal:
    build:
      context: ./apps/admin-portal
      dockerfile: ./Dockerfile
    container_name: caas-admin-portal
    hostname: admin-portal
    ports:
      - "3100:3100"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_API_URL=http://localhost:3000
      - API_URL=http://gateway:3000
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      caas-network:
        ipv4_address: 172.28.6.2
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://127.0.0.1:3100/api/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================================
  # DEVELOPMENT & MONITORING TOOLS
  # ============================================

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: caas-kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: caas-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-1:29092,kafka-2:29092,kafka-3:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
      DYNAMIC_CONFIG_ENABLED: "true"
    networks:
      - caas-network
    depends_on:
      - kafka-1
      - schema-registry
    restart: unless-stopped

  mongo-express:
    image: mongo-express:latest
    container_name: caas-mongo-express
    ports:
      - "8082:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_ROOT_USER:-caas_admin}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_ROOT_PASSWORD:-caas_secret_2026}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017,mongodb-secondary-1:27017,mongodb-secondary-2:27017/?replicaSet=caas-rs
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USER:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD:-admin123}
    networks:
      - caas-network
    depends_on:
      mongodb-primary:
        condition: service_healthy
    restart: unless-stopped

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: caas-redis-commander
    environment:
      REDIS_HOSTS: gateway:redis-gateway:6379:0:${REDIS_PASSWORD:-caas_redis_2026},socket:redis-socket:6379:0:${REDIS_PASSWORD:-caas_redis_2026},shared:redis-shared:6379:0:${REDIS_PASSWORD:-caas_redis_2026},compliance:redis-compliance:6379:0:${REDIS_PASSWORD:-caas_redis_2026},crypto:redis-crypto:6379:0:${REDIS_PASSWORD:-caas_redis_2026}
    ports:
      - "8083:8081"
    networks:
      - caas-network
    depends_on:
      - redis-gateway
      - redis-socket
      - redis-shared
      - redis-compliance
      - redis-crypto
    restart: unless-stopped

  # ============================================
  # SOCKET SERVICES
  # ============================================

  socket-service-1:
    build:
      context: .
      dockerfile: ./Dockerfile.common
      target: socket-service
    container_name: caas-socket-1
    ports:
      - "3002:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - SOCKET_PORT=3001
      - REDIS_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-socket:6379/0
      - REDIS_SHARED_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-shared:6379/0
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017/caas_platform?authSource=admin&replicaSet=caas-rs
      - KAFKA_BROKERS=kafka-1:29092,kafka-2:29092,kafka-3:29092
      - INSTANCE_ID=socket-1
      - COMPLIANCE_SERVICE_URL=http://compliance-service:3008
      - JWT_SECRET=${JWT_SECRET:-change_this_in_production_please}
      # Phase 4.5.z.x: Auth service integration
      - AUTH_SERVICE_URL=http://auth-service:3001
      - SERVICE_SECRET=${SERVICE_SECRET:-dev-service-secret}
    depends_on:
      redis-socket:
        condition: service_healthy
      redis-shared:
        condition: service_healthy
      mongodb-primary:
        condition: service_healthy
    networks:
      caas-network:
        ipv4_address: 172.28.7.1
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  socket-service-2:
    build:
      context: .
      dockerfile: ./Dockerfile.common
      target: socket-service
    container_name: caas-socket-2
    ports:
      - "3003:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - SOCKET_PORT=3001
      - REDIS_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-socket:6379/0
      - REDIS_SHARED_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-shared:6379/0
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017/caas_platform?authSource=admin&replicaSet=caas-rs
      - KAFKA_BROKERS=kafka-1:29092,kafka-2:29092,kafka-3:29092
      - INSTANCE_ID=socket-2
      - COMPLIANCE_SERVICE_URL=http://compliance-service:3008
      - JWT_SECRET=${JWT_SECRET:-change_this_in_production_please}
      # Phase 4.5.z.x: Auth service integration
      - AUTH_SERVICE_URL=http://auth-service:3001
      - SERVICE_SECRET=${SERVICE_SECRET:-dev-service-secret}
    depends_on:
      redis-socket:
        condition: service_healthy
      redis-shared:
        condition: service_healthy
      mongodb-primary:
        condition: service_healthy
    networks:
      caas-network:
        ipv4_address: 172.28.7.2
    restart: unless-stopped

  # ============================================
  # MESSAGING SERVICE
  # ============================================

  # ============================================
  # TEST SERVICES
  # ============================================

  e2e-new:
    build:
      context: ./tests/new_e2e
      dockerfile: ./Dockerfile
    container_name: caas-e2e-new
    environment:
      - GATEWAY_URL=http://gateway:3000
      - AUTH_SERVICE_URL=http://auth-service:3001
      - COMPLIANCE_SERVICE_URL=http://compliance-service:3008
      - CRYPTO_SERVICE_URL=http://crypto-service:3009
      - SEARCH_SERVICE_URL=http://search-service:3006
      - MEDIA_SERVICE_URL=http://media-service:3005
      - SOCKET1_URL=http://socket-service-1:3001
      - SOCKET2_URL=http://socket-service-2:3001
      - ADMIN_PORTAL_URL=http://admin-portal:3100
    depends_on:
      gateway:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      compliance-service:
        condition: service_healthy
      crypto-service:
        condition: service_healthy
      search-service:
        condition: service_healthy
      media-service:
        condition: service_healthy
      socket-service-1:
        condition: service_started
      socket-service-2:
        condition: service_started
      admin-portal:
        condition: service_started
    networks:
      - caas-network
    volumes:
      - ./tests/new_e2e/reports:/tests/new_e2e/reports
    restart: "no"
    profiles:
      - test

  # ============================================
  # SEARCH SERVICE
  # ============================================

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: caas-elasticsearch
    hostname: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD:-changeme}
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      caas-network:
        ipv4_address: 172.28.10.1
    healthcheck:
      test: curl -u elastic:${ELASTICSEARCH_PASSWORD:-changeme} -s http://localhost:9200/_cluster/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  search-service:
    build:
      context: .
      dockerfile: ./Dockerfile.common
      target: search-service
    container_name: caas-search-service
    ports:
      - "3006:3006"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3006
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD:-changeme}
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017/caas_platform?authSource=admin&replicaSet=caas-rs
      - REDIS_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-shared:6379/0
      - KAFKA_BROKERS=kafka-1:29092,kafka-2:29092,kafka-3:29092
      - COMPLIANCE_SERVICE_URL=http://compliance-service:3008
    depends_on:
      elasticsearch:
        condition: service_healthy
      mongodb-primary:
        condition: service_healthy
      redis-shared:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
    networks:
      caas-network:
        ipv4_address: 172.28.10.2
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://127.0.0.1:3006/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================
  # OBJECT STORAGE
  # ============================================

  minio:
    image: minio/minio:latest
    container_name: caas-minio
    hostname: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      caas-network:
        ipv4_address: 172.28.9.1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================
  # MEDIA SERVICE
  # ============================================

  media-service:
    build:
      context: .
      dockerfile: ./Dockerfile.common
      target: media-service
    container_name: caas-media-service
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - MONGODB_URI=mongodb://${MONGO_ROOT_USER:-caas_admin}:${MONGO_ROOT_PASSWORD:-caas_secret_2026}@mongodb-primary:27017/caas_platform?authSource=admin&replicaSet=caas-rs
      - REDIS_URL=redis://:${REDIS_PASSWORD:-caas_redis_2026}@redis-shared:6379/0
      - KAFKA_BROKERS=kafka-1:29092,kafka-2:29092,kafka-3:29092
      - AUTH_SERVICE_URL=http://auth-service:3001
      - SERVICE_SECRET=${SERVICE_SECRET:-dev-service-secret}
      - COMPLIANCE_SERVICE_URL=http://compliance-service:3008
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=caas-media
      - S3_REGION=us-east-1
      - SIGNED_URL_EXPIRY=3600
    depends_on:
      mongodb-primary:
        condition: service_healthy
      redis-shared:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      caas-network:
        ipv4_address: 172.28.9.2
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://127.0.0.1:3005/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
